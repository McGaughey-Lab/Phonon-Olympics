#!/bin/sh

for ecutwfc in 90;
do

echo ${ecutwfc}

for ecutrho in 320;
do

for k in 1;
do

for mag in 0.22;
do

condition_name=ecutwfc_${ecutwfc}_ecutrho_${ecutrho}_kpoint_${k}_mag_${mag}

prefix=MoSe661_${condition_name}

cat << EOF > ${prefix}.alm.in
&general
  PREFIX = ${prefix}
  MODE = suggest
  NAT = 108
  NKD = 2
  KD = Mo Se 
  PERIODIC = 1 1 0
/

&interaction
  NORDER = 2
/

&cell
  1.8897261246257702
  19.62 0.0 0.0
  -9.81 16.991418422250685 0.0
  0.0 0.0 22.0
/

&cutoff
  *-* 13 14
/

&position
  1 0.0 0.0 0.5
  2 0.0555555555555556 0.1111111111111111 0.5754545454545454
  2 0.0555555555555556 0.1111111111111111 0.4245454545454546
  1 -0.0 0.1666666666666666 0.5
  2 0.0555555555555556 0.2777777777777778 0.5754545454545454
  2 0.0555555555555556 0.2777777777777778 0.4245454545454546
  1 -0.0 0.3333333333333333 0.5
  2 0.0555555555555556 0.4444444444444445 0.5754545454545454
  2 0.0555555555555556 0.4444444444444445 0.4245454545454546
  1 0.0 0.5 0.5
  2 0.0555555555555555 0.611111111111111 0.5754545454545454
  2 0.0555555555555555 0.611111111111111 0.4245454545454546
  1 -0.0 0.6666666666666666 0.5
  2 0.0555555555555556 0.7777777777777779 0.5754545454545454
  2 0.0555555555555556 0.7777777777777779 0.4245454545454546
  1 0.0 0.8333333333333334 0.5
  2 0.0555555555555555 0.9444444444444444 0.5754545454545454
  2 0.0555555555555555 0.9444444444444444 0.4245454545454546
  1 0.1666666666666666 0.0 0.5
  2 0.2222222222222222 0.1111111111111111 0.5754545454545454
  2 0.2222222222222222 0.1111111111111111 0.4245454545454546
  1 0.1666666666666666 0.1666666666666666 0.5
  2 0.2222222222222222 0.2777777777777778 0.5754545454545454
  2 0.2222222222222222 0.2777777777777778 0.4245454545454546
  1 0.1666666666666666 0.3333333333333333 0.5
  2 0.2222222222222222 0.4444444444444445 0.5754545454545454
  2 0.2222222222222222 0.4444444444444445 0.4245454545454546
  1 0.1666666666666667 0.5 0.5
  2 0.2222222222222222 0.611111111111111 0.5754545454545454
  2 0.2222222222222222 0.611111111111111 0.4245454545454546
  1 0.1666666666666666 0.6666666666666666 0.5
  2 0.2222222222222223 0.7777777777777779 0.5754545454545454
  2 0.2222222222222223 0.7777777777777779 0.4245454545454546
  1 0.1666666666666667 0.8333333333333334 0.5
  2 0.2222222222222222 0.9444444444444444 0.5754545454545454
  2 0.2222222222222222 0.9444444444444444 0.4245454545454546
  1 0.3333333333333333 0.0 0.5
  2 0.3888888888888888 0.1111111111111111 0.5754545454545454
  2 0.3888888888888888 0.1111111111111111 0.4245454545454546
  1 0.3333333333333333 0.1666666666666666 0.5
  2 0.3888888888888889 0.2777777777777778 0.5754545454545454
  2 0.3888888888888889 0.2777777777777778 0.4245454545454546
  1 0.3333333333333333 0.3333333333333333 0.5
  2 0.3888888888888889 0.4444444444444445 0.5754545454545454
  2 0.3888888888888889 0.4444444444444445 0.4245454545454546
  1 0.3333333333333333 0.5 0.5
  2 0.3888888888888888 0.611111111111111 0.5754545454545454
  2 0.3888888888888888 0.611111111111111 0.4245454545454546
  1 0.3333333333333333 0.6666666666666666 0.5
  2 0.388888888888889 0.7777777777777779 0.5754545454545454
  2 0.388888888888889 0.7777777777777779 0.4245454545454546
  1 0.3333333333333334 0.8333333333333334 0.5
  2 0.3888888888888888 0.9444444444444444 0.5754545454545454
  2 0.3888888888888888 0.9444444444444444 0.4245454545454546
  1 0.5 0.0 0.5
  2 0.5555555555555556 0.1111111111111111 0.5754545454545454
  2 0.5555555555555556 0.1111111111111111 0.4245454545454546
  1 0.5 0.1666666666666666 0.5
  2 0.5555555555555556 0.2777777777777778 0.5754545454545454
  2 0.5555555555555556 0.2777777777777778 0.4245454545454546
  1 0.5 0.3333333333333333 0.5
  2 0.5555555555555557 0.4444444444444445 0.5754545454545454
  2 0.5555555555555557 0.4444444444444445 0.4245454545454546
  1 0.5 0.5 0.5
  2 0.5555555555555556 0.611111111111111 0.5754545454545454
  2 0.5555555555555556 0.611111111111111 0.4245454545454546
  1 0.5 0.6666666666666666 0.5
  2 0.5555555555555557 0.7777777777777779 0.5754545454545454
  2 0.5555555555555557 0.7777777777777779 0.4245454545454546
  1 0.5 0.8333333333333334 0.5
  2 0.5555555555555556 0.9444444444444444 0.5754545454545454
  2 0.5555555555555556 0.9444444444444444 0.4245454545454546
  1 0.6666666666666666 0.0 0.5
  2 0.7222222222222222 0.1111111111111111 0.5754545454545454
  2 0.7222222222222222 0.1111111111111111 0.4245454545454546
  1 0.6666666666666666 0.1666666666666666 0.5
  2 0.7222222222222222 0.2777777777777778 0.5754545454545454
  2 0.7222222222222222 0.2777777777777778 0.4245454545454546
  1 0.6666666666666666 0.3333333333333333 0.5
  2 0.7222222222222223 0.4444444444444445 0.5754545454545454
  2 0.7222222222222223 0.4444444444444445 0.4245454545454546
  1 0.6666666666666667 0.5 0.5
  2 0.7222222222222222 0.611111111111111 0.5754545454545454
  2 0.7222222222222222 0.611111111111111 0.4245454545454546
  1 0.6666666666666666 0.6666666666666666 0.5
  2 0.7222222222222223 0.7777777777777779 0.5754545454545454
  2 0.7222222222222223 0.7777777777777779 0.4245454545454546
  1 0.6666666666666667 0.8333333333333334 0.5
  2 0.7222222222222222 0.9444444444444444 0.5754545454545454
  2 0.7222222222222222 0.9444444444444444 0.4245454545454546
  1 0.8333333333333334 0.0 0.5
  2 0.888888888888889 0.1111111111111111 0.5754545454545454
  2 0.888888888888889 0.1111111111111111 0.4245454545454546
  1 0.8333333333333334 0.1666666666666666 0.5
  2 0.888888888888889 0.2777777777777778 0.5754545454545454
  2 0.888888888888889 0.2777777777777778 0.4245454545454546
  1 0.8333333333333334 0.3333333333333333 0.5
  2 0.888888888888889 0.4444444444444445 0.5754545454545454
  2 0.888888888888889 0.4444444444444445 0.4245454545454546
  1 0.8333333333333334 0.5 0.5
  2 0.888888888888889 0.611111111111111 0.5754545454545454
  2 0.888888888888889 0.611111111111111 0.4245454545454546
  1 0.8333333333333334 0.6666666666666666 0.5
  2 0.8888888888888891 0.7777777777777779 0.5754545454545454
  2 0.8888888888888891 0.7777777777777779 0.4245454545454546
  1 0.8333333333333334 0.8333333333333334 0.5
  2 0.888888888888889 0.9444444444444444 0.5754545454545454
  2 0.888888888888889 0.9444444444444444 0.4245454545454546
/

EOF

${ALMDIR}/alm/alm ${prefix}.alm.in > ${prefix}.alm.log0 2> ${prefix}.alm.err

cat << EOF > pw.scf_${condition_name}.in
&CONTROL
   calculation      = 'scf'
   tstress          = .true.
   tprnfor          = .true.
   outdir           = 'MoSe2'
   prefix           = 'MoSe2'
   pseudo_dir       = './'
/
&SYSTEM
   ecutwfc          = ${ecutwfc}
   ecutrho          = ${ecutrho}
   occupations      = 'fixed'
   ntyp             = 2
   nat              = 108
   ibrav            = 0
/
&ELECTRONS
   electron_maxstep = 300
   conv_thr         = 1e-10
/
&IONS
/
&CELL
/

ATOMIC_SPECIES
Mo 95.94873241 Mo.pbesol-spn-kjpaw_psl.1.0.0.UPF
Se 78.9595608 Se.pbesol-dn-kjpaw_psl.1.0.0.UPF

K_POINTS automatic
${k} ${k} 1 0 0 0

CELL_PARAMETERS angstrom
19.62000000000000 0.00000000000000 0.00000000000000
-9.81000000000000 16.99141842225069 0.00000000000000
0.00000000000000 0.00000000000000 22.00000000000000

ATOMIC_POSITIONS angstrom
Mo 0.0000000000 0.0000000000 11.0000000000 
Se 0.0000000000 1.8879353803 12.6600000000 
Se 0.0000000000 1.8879353803 9.3400000000 
Mo -1.6350000000 2.8319030704 11.0000000000 
Se -1.6350000000 4.7198384506 12.6600000000 
Se -1.6350000000 4.7198384506 9.3400000000 
Mo -3.2700000000 5.6638061408 11.0000000000 
Se -3.2700000000 7.5517415210 12.6600000000 
Se -3.2700000000 7.5517415210 9.3400000000 
Mo -4.9050000000 8.4957092111 11.0000000000 
Se -4.9050000000 10.3836445914 12.6600000000 
Se -4.9050000000 10.3836445914 9.3400000000 
Mo -6.5400000000 11.3276122815 11.0000000000 
Se -6.5400000000 13.2155476618 12.6600000000 
Se -6.5400000000 13.2155476618 9.3400000000 
Mo -8.1750000000 14.1595153519 11.0000000000 
Se -8.1750000000 16.0474507321 12.6600000000 
Se -8.1750000000 16.0474507321 9.3400000000 
Mo 3.2700000000 0.0000000000 11.0000000000 
Se 3.2700000000 1.8879353803 12.6600000000 
Se 3.2700000000 1.8879353803 9.3400000000 
Mo 1.6350000000 2.8319030704 11.0000000000 
Se 1.6350000000 4.7198384506 12.6600000000 
Se 1.6350000000 4.7198384506 9.3400000000 
Mo 0.0000000000 5.6638061408 11.0000000000 
Se 0.0000000000 7.5517415210 12.6600000000 
Se 0.0000000000 7.5517415210 9.3400000000 
Mo -1.6350000000 8.4957092111 11.0000000000 
Se -1.6350000000 10.3836445914 12.6600000000 
Se -1.6350000000 10.3836445914 9.3400000000 
Mo -3.2700000000 11.3276122815 11.0000000000 
Se -3.2700000000 13.2155476618 12.6600000000 
Se -3.2700000000 13.2155476618 9.3400000000 
Mo -4.9050000000 14.1595153519 11.0000000000 
Se -4.9050000000 16.0474507321 12.6600000000 
Se -4.9050000000 16.0474507321 9.3400000000 
Mo 6.5400000000 0.0000000000 11.0000000000 
Se 6.5400000000 1.8879353803 12.6600000000 
Se 6.5400000000 1.8879353803 9.3400000000 
Mo 4.9050000000 2.8319030704 11.0000000000 
Se 4.9050000000 4.7198384506 12.6600000000 
Se 4.9050000000 4.7198384506 9.3400000000 
Mo 3.2700000000 5.6638061408 11.0000000000 
Se 3.2700000000 7.5517415210 12.6600000000 
Se 3.2700000000 7.5517415210 9.3400000000 
Mo 1.6350000000 8.4957092111 11.0000000000 
Se 1.6350000000 10.3836445914 12.6600000000 
Se 1.6350000000 10.3836445914 9.3400000000 
Mo 0.0000000000 11.3276122815 11.0000000000 
Se 0.0000000000 13.2155476618 12.6600000000 
Se 0.0000000000 13.2155476618 9.3400000000 
Mo -1.6350000000 14.1595153519 11.0000000000 
Se -1.6350000000 16.0474507321 12.6600000000 
Se -1.6350000000 16.0474507321 9.3400000000 
Mo 9.8100000000 0.0000000000 11.0000000000 
Se 9.8100000000 1.8879353803 12.6600000000 
Se 9.8100000000 1.8879353803 9.3400000000 
Mo 8.1750000000 2.8319030704 11.0000000000 
Se 8.1750000000 4.7198384506 12.6600000000 
Se 8.1750000000 4.7198384506 9.3400000000 
Mo 6.5400000000 5.6638061408 11.0000000000 
Se 6.5400000000 7.5517415210 12.6600000000 
Se 6.5400000000 7.5517415210 9.3400000000 
Mo 4.9050000000 8.4957092111 11.0000000000 
Se 4.9050000000 10.3836445914 12.6600000000 
Se 4.9050000000 10.3836445914 9.3400000000 
Mo 3.2700000000 11.3276122815 11.0000000000 
Se 3.2700000000 13.2155476618 12.6600000000 
Se 3.2700000000 13.2155476618 9.3400000000 
Mo 1.6350000000 14.1595153519 11.0000000000 
Se 1.6350000000 16.0474507321 12.6600000000 
Se 1.6350000000 16.0474507321 9.3400000000 
Mo 13.0800000000 0.0000000000 11.0000000000 
Se 13.0800000000 1.8879353803 12.6600000000 
Se 13.0800000000 1.8879353803 9.3400000000 
Mo 11.4450000000 2.8319030704 11.0000000000 
Se 11.4450000000 4.7198384506 12.6600000000 
Se 11.4450000000 4.7198384506 9.3400000000 
Mo 9.8100000000 5.6638061408 11.0000000000 
Se 9.8100000000 7.5517415210 12.6600000000 
Se 9.8100000000 7.5517415210 9.3400000000 
Mo 8.1750000000 8.4957092111 11.0000000000 
Se 8.1750000000 10.3836445914 12.6600000000 
Se 8.1750000000 10.3836445914 9.3400000000 
Mo 6.5400000000 11.3276122815 11.0000000000 
Se 6.5400000000 13.2155476618 12.6600000000 
Se 6.5400000000 13.2155476618 9.3400000000 
Mo 4.9050000000 14.1595153519 11.0000000000 
Se 4.9050000000 16.0474507321 12.6600000000 
Se 4.9050000000 16.0474507321 9.3400000000 
Mo 16.3500000000 0.0000000000 11.0000000000 
Se 16.3500000000 1.8879353803 12.6600000000 
Se 16.3500000000 1.8879353803 9.3400000000 
Mo 14.7150000000 2.8319030704 11.0000000000 
Se 14.7150000000 4.7198384506 12.6600000000 
Se 14.7150000000 4.7198384506 9.3400000000 
Mo 13.0800000000 5.6638061408 11.0000000000 
Se 13.0800000000 7.5517415210 12.6600000000 
Se 13.0800000000 7.5517415210 9.3400000000 
Mo 11.4450000000 8.4957092111 11.0000000000 
Se 11.4450000000 10.3836445914 12.6600000000 
Se 11.4450000000 10.3836445914 9.3400000000 
Mo 9.8100000000 11.3276122815 11.0000000000 
Se 9.8100000000 13.2155476618 12.6600000000 
Se 9.8100000000 13.2155476618 9.3400000000 
Mo 8.1750000000 14.1595153519 11.0000000000 
Se 8.1750000000 16.0474507321 12.6600000000 
Se 8.1750000000 16.0474507321 9.3400000000

EOF

python ${ALMDIR}/tools/displace.py --QE=pw.scf_${condition_name}.in --prefix cubic --mag=${mag} -pf ${prefix}.pattern_ANHARM3 > displace.log

cubics=($(ls cubic*.pw.in))

for cubic in ${cubics[@]};
do
echo ${cubic:0:-2}'out'
pw.x < ${cubic} > ${cubic:0:-2}'cubic.out' 2> ${cubic:0:-2}'err'
done

cat << EOF > ${prefix}_opt.alm.in
&general
  PREFIX = ${prefix}
  MODE = optimize
  NAT = 108
  NKD = 2
  KD = Mo Se 
  PERIODIC = 1 1 0
/

&interaction
  NORDER = 2
/

&optimize
  DFSET = DFSET_cubic_${condition_name}
  FC2XML = ${prefix}_harm.xml
/

&cell
  1.8897261246257702
  19.62 0.0 0.0
  -9.81 16.991418422250685 0.0
  0.0 0.0 22.0
/

&cutoff
  *-* 13 14
/

&position
  1 0.0 0.0 0.5
  2 0.0555555555555556 0.1111111111111111 0.5754545454545454
  2 0.0555555555555556 0.1111111111111111 0.4245454545454546
  1 -0.0 0.1666666666666666 0.5
  2 0.0555555555555556 0.2777777777777778 0.5754545454545454
  2 0.0555555555555556 0.2777777777777778 0.4245454545454546
  1 -0.0 0.3333333333333333 0.5
  2 0.0555555555555556 0.4444444444444445 0.5754545454545454
  2 0.0555555555555556 0.4444444444444445 0.4245454545454546
  1 0.0 0.5 0.5
  2 0.0555555555555555 0.611111111111111 0.5754545454545454
  2 0.0555555555555555 0.611111111111111 0.4245454545454546
  1 -0.0 0.6666666666666666 0.5
  2 0.0555555555555556 0.7777777777777779 0.5754545454545454
  2 0.0555555555555556 0.7777777777777779 0.4245454545454546
  1 0.0 0.8333333333333334 0.5
  2 0.0555555555555555 0.9444444444444444 0.5754545454545454
  2 0.0555555555555555 0.9444444444444444 0.4245454545454546
  1 0.1666666666666666 0.0 0.5
  2 0.2222222222222222 0.1111111111111111 0.5754545454545454
  2 0.2222222222222222 0.1111111111111111 0.4245454545454546
  1 0.1666666666666666 0.1666666666666666 0.5
  2 0.2222222222222222 0.2777777777777778 0.5754545454545454
  2 0.2222222222222222 0.2777777777777778 0.4245454545454546
  1 0.1666666666666666 0.3333333333333333 0.5
  2 0.2222222222222222 0.4444444444444445 0.5754545454545454
  2 0.2222222222222222 0.4444444444444445 0.4245454545454546
  1 0.1666666666666667 0.5 0.5
  2 0.2222222222222222 0.611111111111111 0.5754545454545454
  2 0.2222222222222222 0.611111111111111 0.4245454545454546
  1 0.1666666666666666 0.6666666666666666 0.5
  2 0.2222222222222223 0.7777777777777779 0.5754545454545454
  2 0.2222222222222223 0.7777777777777779 0.4245454545454546
  1 0.1666666666666667 0.8333333333333334 0.5
  2 0.2222222222222222 0.9444444444444444 0.5754545454545454
  2 0.2222222222222222 0.9444444444444444 0.4245454545454546
  1 0.3333333333333333 0.0 0.5
  2 0.3888888888888888 0.1111111111111111 0.5754545454545454
  2 0.3888888888888888 0.1111111111111111 0.4245454545454546
  1 0.3333333333333333 0.1666666666666666 0.5
  2 0.3888888888888889 0.2777777777777778 0.5754545454545454
  2 0.3888888888888889 0.2777777777777778 0.4245454545454546
  1 0.3333333333333333 0.3333333333333333 0.5
  2 0.3888888888888889 0.4444444444444445 0.5754545454545454
  2 0.3888888888888889 0.4444444444444445 0.4245454545454546
  1 0.3333333333333333 0.5 0.5
  2 0.3888888888888888 0.611111111111111 0.5754545454545454
  2 0.3888888888888888 0.611111111111111 0.4245454545454546
  1 0.3333333333333333 0.6666666666666666 0.5
  2 0.388888888888889 0.7777777777777779 0.5754545454545454
  2 0.388888888888889 0.7777777777777779 0.4245454545454546
  1 0.3333333333333334 0.8333333333333334 0.5
  2 0.3888888888888888 0.9444444444444444 0.5754545454545454
  2 0.3888888888888888 0.9444444444444444 0.4245454545454546
  1 0.5 0.0 0.5
  2 0.5555555555555556 0.1111111111111111 0.5754545454545454
  2 0.5555555555555556 0.1111111111111111 0.4245454545454546
  1 0.5 0.1666666666666666 0.5
  2 0.5555555555555556 0.2777777777777778 0.5754545454545454
  2 0.5555555555555556 0.2777777777777778 0.4245454545454546
  1 0.5 0.3333333333333333 0.5
  2 0.5555555555555557 0.4444444444444445 0.5754545454545454
  2 0.5555555555555557 0.4444444444444445 0.4245454545454546
  1 0.5 0.5 0.5
  2 0.5555555555555556 0.611111111111111 0.5754545454545454
  2 0.5555555555555556 0.611111111111111 0.4245454545454546
  1 0.5 0.6666666666666666 0.5
  2 0.5555555555555557 0.7777777777777779 0.5754545454545454
  2 0.5555555555555557 0.7777777777777779 0.4245454545454546
  1 0.5 0.8333333333333334 0.5
  2 0.5555555555555556 0.9444444444444444 0.5754545454545454
  2 0.5555555555555556 0.9444444444444444 0.4245454545454546
  1 0.6666666666666666 0.0 0.5
  2 0.7222222222222222 0.1111111111111111 0.5754545454545454
  2 0.7222222222222222 0.1111111111111111 0.4245454545454546
  1 0.6666666666666666 0.1666666666666666 0.5
  2 0.7222222222222222 0.2777777777777778 0.5754545454545454
  2 0.7222222222222222 0.2777777777777778 0.4245454545454546
  1 0.6666666666666666 0.3333333333333333 0.5
  2 0.7222222222222223 0.4444444444444445 0.5754545454545454
  2 0.7222222222222223 0.4444444444444445 0.4245454545454546
  1 0.6666666666666667 0.5 0.5
  2 0.7222222222222222 0.611111111111111 0.5754545454545454
  2 0.7222222222222222 0.611111111111111 0.4245454545454546
  1 0.6666666666666666 0.6666666666666666 0.5
  2 0.7222222222222223 0.7777777777777779 0.5754545454545454
  2 0.7222222222222223 0.7777777777777779 0.4245454545454546
  1 0.6666666666666667 0.8333333333333334 0.5
  2 0.7222222222222222 0.9444444444444444 0.5754545454545454
  2 0.7222222222222222 0.9444444444444444 0.4245454545454546
  1 0.8333333333333334 0.0 0.5
  2 0.888888888888889 0.1111111111111111 0.5754545454545454
  2 0.888888888888889 0.1111111111111111 0.4245454545454546
  1 0.8333333333333334 0.1666666666666666 0.5
  2 0.888888888888889 0.2777777777777778 0.5754545454545454
  2 0.888888888888889 0.2777777777777778 0.4245454545454546
  1 0.8333333333333334 0.3333333333333333 0.5
  2 0.888888888888889 0.4444444444444445 0.5754545454545454
  2 0.888888888888889 0.4444444444444445 0.4245454545454546
  1 0.8333333333333334 0.5 0.5
  2 0.888888888888889 0.611111111111111 0.5754545454545454
  2 0.888888888888889 0.611111111111111 0.4245454545454546
  1 0.8333333333333334 0.6666666666666666 0.5
  2 0.8888888888888891 0.7777777777777779 0.5754545454545454
  2 0.8888888888888891 0.7777777777777779 0.4245454545454546
  1 0.8333333333333334 0.8333333333333334 0.5
  2 0.888888888888889 0.9444444444444444 0.5754545454545454
  2 0.888888888888889 0.9444444444444444 0.4245454545454546
/

EOF

python ${ALMDIR}/tools/extract.py --QE=pw.scf_${condition_name}.in *.pw.cubic.out > DFSET_cubic_${condition_name}

${ALMDIR}/alm/alm  ${prefix}_opt.alm.in > ${prefix}_opt.alm.log1 2>  ${prefix}_opt.alm.err

done

done

done

done