#!/bin/sh

QEDIR=/work/app/QuantumESPRESSO/qe-6.8/
ALAMODEDIR=/work/app/ALAMODE/alamode-1.3.0/

#-----------------Calculation-----------------------
for ecutwfc in 90;
do

echo ${ecutwfc}

for ecutrho in 320;
do

for k in 1;
do

for mag in 0.01;
do

condition_name=ecutwfc_${ecutwfc}_ecutrho_${ecutrho}_kpoint_${k}_mag_${mag}

prefix=MoSe_ortho_531_${condition_name}

cat << EOF > ${prefix}.alm.in
&general
  PREFIX = ${prefix}
  MODE = suggest
  NAT = 90
  NKD = 2
  KD = Mo Se 
  PERIODIC = 1 1 0
/

&interaction
  NORDER = 1
/

&cell
  1.8897261246257702
  16.35 0.0 0.0
  0.0 16.991418422250685 0.0
  0.0 0.0 14.0 
/

&cutoff
  *-* 13
/

&position
  1 0.0 0.0 0.4999999999999999
  2 0.0 0.1111111111111111 0.6185714285714285
  2 0.0 0.1111111111111111 0.3814285714285714
  1 0.1 0.1666666666666666 0.4999999999999999
  2 0.1 0.2777777777777778 0.6185714285714285
  2 0.1 0.2777777777777778 0.3814285714285714
  1 0.0 0.3333333333333333 0.4999999999999999
  2 0.0 0.4444444444444445 0.6185714285714285
  2 0.0 0.4444444444444445 0.3814285714285714
  1 0.1 0.5 0.4999999999999999
  2 0.1 0.611111111111111 0.6185714285714285
  2 0.1 0.611111111111111 0.3814285714285714
  1 0.0 0.6666666666666666 0.4999999999999999
  2 0.0 0.7777777777777779 0.6185714285714285
  2 0.0 0.7777777777777779 0.3814285714285714
  1 0.1 0.8333333333333334 0.4999999999999999
  2 0.1 0.9444444444444444 0.6185714285714285
  2 0.1 0.9444444444444444 0.3814285714285714
  1 0.2 0.0 0.4999999999999999
  2 0.2 0.1111111111111111 0.6185714285714285
  2 0.2 0.1111111111111111 0.3814285714285714
  1 0.3 0.1666666666666666 0.4999999999999999
  2 0.3 0.2777777777777778 0.6185714285714285
  2 0.3 0.2777777777777778 0.3814285714285714
  1 0.2 0.3333333333333333 0.4999999999999999
  2 0.2 0.4444444444444445 0.6185714285714285
  2 0.2 0.4444444444444445 0.3814285714285714
  1 0.3 0.5 0.4999999999999999
  2 0.3 0.611111111111111 0.6185714285714285
  2 0.3 0.611111111111111 0.3814285714285714
  1 0.2 0.6666666666666666 0.4999999999999999
  2 0.2 0.7777777777777779 0.6185714285714285
  2 0.2 0.7777777777777779 0.3814285714285714
  1 0.3 0.8333333333333334 0.4999999999999999
  2 0.3 0.9444444444444444 0.6185714285714285
  2 0.3 0.9444444444444444 0.3814285714285714
  1 0.4 0.0 0.4999999999999999
  2 0.4 0.1111111111111111 0.6185714285714285
  2 0.4 0.1111111111111111 0.3814285714285714
  1 0.5 0.1666666666666666 0.4999999999999999
  2 0.5 0.2777777777777778 0.6185714285714285
  2 0.5 0.2777777777777778 0.3814285714285714
  1 0.4 0.3333333333333333 0.4999999999999999
  2 0.4 0.4444444444444445 0.6185714285714285
  2 0.4 0.4444444444444445 0.3814285714285714
  1 0.5 0.5 0.4999999999999999
  2 0.5 0.611111111111111 0.6185714285714285
  2 0.5 0.611111111111111 0.3814285714285714
  1 0.4 0.6666666666666666 0.4999999999999999
  2 0.4 0.7777777777777779 0.6185714285714285
  2 0.4 0.7777777777777779 0.3814285714285714
  1 0.5 0.8333333333333334 0.4999999999999999
  2 0.5 0.9444444444444444 0.6185714285714285
  2 0.5 0.9444444444444444 0.3814285714285714
  1 0.6 0.0 0.4999999999999999
  2 0.6 0.1111111111111111 0.6185714285714285
  2 0.6 0.1111111111111111 0.3814285714285714
  1 0.7 0.1666666666666666 0.4999999999999999
  2 0.7 0.2777777777777778 0.6185714285714285
  2 0.7 0.2777777777777778 0.3814285714285714
  1 0.6 0.3333333333333333 0.4999999999999999
  2 0.6 0.4444444444444445 0.6185714285714285
  2 0.6 0.4444444444444445 0.3814285714285714
  1 0.7 0.5 0.4999999999999999
  2 0.7 0.611111111111111 0.6185714285714285
  2 0.7 0.611111111111111 0.3814285714285714
  1 0.6 0.6666666666666666 0.4999999999999999
  2 0.6 0.7777777777777779 0.6185714285714285
  2 0.6 0.7777777777777779 0.3814285714285714
  1 0.7 0.8333333333333334 0.4999999999999999
  2 0.7 0.9444444444444444 0.6185714285714285
  2 0.7 0.9444444444444444 0.3814285714285714
  1 0.7999999999999999 0.0 0.4999999999999999
  2 0.7999999999999999 0.1111111111111111 0.6185714285714285
  2 0.7999999999999999 0.1111111111111111 0.3814285714285714
  1 0.8999999999999999 0.1666666666666666 0.4999999999999999
  2 0.8999999999999999 0.2777777777777778 0.6185714285714285
  2 0.8999999999999999 0.2777777777777778 0.3814285714285714
  1 0.7999999999999999 0.3333333333333333 0.4999999999999999
  2 0.7999999999999999 0.4444444444444445 0.6185714285714285
  2 0.7999999999999999 0.4444444444444445 0.3814285714285714
  1 0.8999999999999999 0.5 0.4999999999999999
  2 0.8999999999999999 0.611111111111111 0.6185714285714285
  2 0.8999999999999999 0.611111111111111 0.3814285714285714
  1 0.7999999999999999 0.6666666666666666 0.4999999999999999
  2 0.7999999999999999 0.7777777777777779 0.6185714285714285
  2 0.7999999999999999 0.7777777777777779 0.3814285714285714
  1 0.8999999999999999 0.8333333333333334 0.4999999999999999
  2 0.8999999999999999 0.9444444444444444 0.6185714285714285
  2 0.8999999999999999 0.9444444444444444 0.3814285714285714
/
   
 
EOF

${ALAMODEDIR}/alm/alm ${prefix}.alm.in > ${prefix}.alm.log0 2> ${prefix}.alm.err

cat << EOF > pw.scf_${condition_name}.in
&CONTROL
   calculation      = 'scf'
   tstress          = .true.
   tprnfor          = .true.
   outdir           = 'MoSe2'
   prefix           = 'MoSe2'
   pseudo_dir       = '/home/tomuhama/mose2_mono/harmonic/'
/
&SYSTEM
   ecutwfc          = ${ecutwfc}
   ecutrho          = ${ecutrho}
   occupations      = 'fixed'
   ntyp             = 2
   nat              = 90
   ibrav            = 0
/
&ELECTRONS
   electron_maxstep = 300
   conv_thr         = 1e-10
/
&IONS
/
&CELL
/

ATOMIC_SPECIES
Mo 95.94873241 Mo.pbesol-spn-kjpaw_psl.1.0.0.UPF
Se 78.9595608 Se.pbesol-dn-kjpaw_psl.1.0.0.UPF

K_POINTS automatic
${k} ${k} 1 0 0 0

CELL_PARAMETERS angstrom
16.35000000000000 0.00000000000000 0.00000000000000
0.00000000000000 16.99141842225069 0.00000000000000
0.00000000000000 0.00000000000000 14.00000000000000

ATOMIC_POSITIONS angstrom
Mo 0.0000000000 0.0000000000 7.0000000000 
Se 0.0000000000 1.8879353803 8.6600000000 
Se 0.0000000000 1.8879353803 5.3400000000 
Mo 1.6350000000 2.8319030704 7.0000000000 
Se 1.6350000000 4.7198384506 8.6600000000 
Se 1.6350000000 4.7198384506 5.3400000000 
Mo 0.0000000000 5.6638061408 7.0000000000 
Se 0.0000000000 7.5517415210 8.6600000000 
Se 0.0000000000 7.5517415210 5.3400000000 
Mo 1.6350000000 8.4957092111 7.0000000000 
Se 1.6350000000 10.3836445914 8.6600000000 
Se 1.6350000000 10.3836445914 5.3400000000 
Mo 0.0000000000 11.3276122815 7.0000000000 
Se 0.0000000000 13.2155476618 8.6600000000 
Se 0.0000000000 13.2155476618 5.3400000000 
Mo 1.6350000000 14.1595153519 7.0000000000 
Se 1.6350000000 16.0474507321 8.6600000000 
Se 1.6350000000 16.0474507321 5.3400000000 
Mo 3.2700000000 0.0000000000 7.0000000000 
Se 3.2700000000 1.8879353803 8.6600000000 
Se 3.2700000000 1.8879353803 5.3400000000 
Mo 4.9050000000 2.8319030704 7.0000000000 
Se 4.9050000000 4.7198384506 8.6600000000 
Se 4.9050000000 4.7198384506 5.3400000000 
Mo 3.2700000000 5.6638061408 7.0000000000 
Se 3.2700000000 7.5517415210 8.6600000000 
Se 3.2700000000 7.5517415210 5.3400000000 
Mo 4.9050000000 8.4957092111 7.0000000000 
Se 4.9050000000 10.3836445914 8.6600000000 
Se 4.9050000000 10.3836445914 5.3400000000 
Mo 3.2700000000 11.3276122815 7.0000000000 
Se 3.2700000000 13.2155476618 8.6600000000 
Se 3.2700000000 13.2155476618 5.3400000000 
Mo 4.9050000000 14.1595153519 7.0000000000 
Se 4.9050000000 16.0474507321 8.6600000000 
Se 4.9050000000 16.0474507321 5.3400000000 
Mo 6.5400000000 0.0000000000 7.0000000000 
Se 6.5400000000 1.8879353803 8.6600000000 
Se 6.5400000000 1.8879353803 5.3400000000 
Mo 8.1750000000 2.8319030704 7.0000000000 
Se 8.1750000000 4.7198384506 8.6600000000 
Se 8.1750000000 4.7198384506 5.3400000000 
Mo 6.5400000000 5.6638061408 7.0000000000 
Se 6.5400000000 7.5517415210 8.6600000000 
Se 6.5400000000 7.5517415210 5.3400000000 
Mo 8.1750000000 8.4957092111 7.0000000000 
Se 8.1750000000 10.3836445914 8.6600000000 
Se 8.1750000000 10.3836445914 5.3400000000 
Mo 6.5400000000 11.3276122815 7.0000000000 
Se 6.5400000000 13.2155476618 8.6600000000 
Se 6.5400000000 13.2155476618 5.3400000000 
Mo 8.1750000000 14.1595153519 7.0000000000 
Se 8.1750000000 16.0474507321 8.6600000000 
Se 8.1750000000 16.0474507321 5.3400000000 
Mo 9.8100000000 0.0000000000 7.0000000000 
Se 9.8100000000 1.8879353803 8.6600000000 
Se 9.8100000000 1.8879353803 5.3400000000 
Mo 11.4450000000 2.8319030704 7.0000000000 
Se 11.4450000000 4.7198384506 8.6600000000 
Se 11.4450000000 4.7198384506 5.3400000000 
Mo 9.8100000000 5.6638061408 7.0000000000 
Se 9.8100000000 7.5517415210 8.6600000000 
Se 9.8100000000 7.5517415210 5.3400000000 
Mo 11.4450000000 8.4957092111 7.0000000000 
Se 11.4450000000 10.3836445914 8.6600000000 
Se 11.4450000000 10.3836445914 5.3400000000 
Mo 9.8100000000 11.3276122815 7.0000000000 
Se 9.8100000000 13.2155476618 8.6600000000 
Se 9.8100000000 13.2155476618 5.3400000000 
Mo 11.4450000000 14.1595153519 7.0000000000 
Se 11.4450000000 16.0474507321 8.6600000000 
Se 11.4450000000 16.0474507321 5.3400000000 
Mo 13.0800000000 0.0000000000 7.0000000000 
Se 13.0800000000 1.8879353803 8.6600000000 
Se 13.0800000000 1.8879353803 5.3400000000 
Mo 14.7150000000 2.8319030704 7.0000000000 
Se 14.7150000000 4.7198384506 8.6600000000 
Se 14.7150000000 4.7198384506 5.3400000000 
Mo 13.0800000000 5.6638061408 7.0000000000 
Se 13.0800000000 7.5517415210 8.6600000000 
Se 13.0800000000 7.5517415210 5.3400000000 
Mo 14.7150000000 8.4957092111 7.0000000000 
Se 14.7150000000 10.3836445914 8.6600000000 
Se 14.7150000000 10.3836445914 5.3400000000 
Mo 13.0800000000 11.3276122815 7.0000000000 
Se 13.0800000000 13.2155476618 8.6600000000 
Se 13.0800000000 13.2155476618 5.3400000000 
Mo 14.7150000000 14.1595153519 7.0000000000 
Se 14.7150000000 16.0474507321 8.6600000000 
Se 14.7150000000 16.0474507321 5.3400000000 


EOF

python ${ALAMODEDIR}/tools/displace.py --QE=pw.scf_${condition_name}.in --mag=${mag} -pf ${prefix}.pattern_HARMONIC > displace.log

disps=($(ls disp*.pw.in))

for disp in ${disps[@]};
do
echo ${disp:0:-2}'out'
${QEDIR}/bin/pw.x < ${disp} > ${disp:0:-2}'out' 2> ${disp:0:-2}'err'
done

python ${ALAMODEDIR}/tools/extract.py --QE=pw.scf_${condition_name}.in *.pw.out > DFSET_harmonic_${condition_name}


cat << EOF > ${prefix}_opt.alm.in
&general
  PREFIX = ${prefix}
  MODE = optimize
  NAT = 90
  NKD = 2
  KD = Mo Se
  PERIODIC = 1 1 0
/

&interaction
  NORDER = 1
/

&optimize
  DFSET = DFSET_harmonic_${condition_name}
/

&cell
  1.8897261246257702
  16.35 0.0 0.0
  0.0 16.991418422250685 0.0
  0.0 0.0 14.0
/

&cutoff
  *-* 13
/

&position
  1 0.0 0.0 0.4999999999999999
  2 0.0 0.1111111111111111 0.6185714285714285
  2 0.0 0.1111111111111111 0.3814285714285714
  1 0.1 0.1666666666666666 0.4999999999999999
  2 0.1 0.2777777777777778 0.6185714285714285
  2 0.1 0.2777777777777778 0.3814285714285714
  1 0.0 0.3333333333333333 0.4999999999999999
  2 0.0 0.4444444444444445 0.6185714285714285
  2 0.0 0.4444444444444445 0.3814285714285714
  1 0.1 0.5 0.4999999999999999
  2 0.1 0.611111111111111 0.6185714285714285
  2 0.1 0.611111111111111 0.3814285714285714
  1 0.0 0.6666666666666666 0.4999999999999999
  2 0.0 0.7777777777777779 0.6185714285714285
  2 0.0 0.7777777777777779 0.3814285714285714
  1 0.1 0.8333333333333334 0.4999999999999999
  2 0.1 0.9444444444444444 0.6185714285714285
  2 0.1 0.9444444444444444 0.3814285714285714
  1 0.2 0.0 0.4999999999999999
  2 0.2 0.1111111111111111 0.6185714285714285
  2 0.2 0.1111111111111111 0.3814285714285714
  1 0.3 0.1666666666666666 0.4999999999999999
  2 0.3 0.2777777777777778 0.6185714285714285
  2 0.3 0.2777777777777778 0.3814285714285714
  1 0.2 0.3333333333333333 0.4999999999999999
  2 0.2 0.4444444444444445 0.6185714285714285
  2 0.2 0.4444444444444445 0.3814285714285714
  1 0.3 0.5 0.4999999999999999
  2 0.3 0.611111111111111 0.6185714285714285
  2 0.3 0.611111111111111 0.3814285714285714
  1 0.2 0.6666666666666666 0.4999999999999999
  2 0.2 0.7777777777777779 0.6185714285714285
  2 0.2 0.7777777777777779 0.3814285714285714
  1 0.3 0.8333333333333334 0.4999999999999999
  2 0.3 0.9444444444444444 0.6185714285714285
  2 0.3 0.9444444444444444 0.3814285714285714
  1 0.4 0.0 0.4999999999999999
  2 0.4 0.1111111111111111 0.6185714285714285
  2 0.4 0.1111111111111111 0.3814285714285714
  1 0.5 0.1666666666666666 0.4999999999999999
  2 0.5 0.2777777777777778 0.6185714285714285
  2 0.5 0.2777777777777778 0.3814285714285714
  1 0.4 0.3333333333333333 0.4999999999999999
  2 0.4 0.4444444444444445 0.6185714285714285
  2 0.4 0.4444444444444445 0.3814285714285714
  1 0.5 0.5 0.4999999999999999
  2 0.5 0.611111111111111 0.6185714285714285
  2 0.5 0.611111111111111 0.3814285714285714
  1 0.4 0.6666666666666666 0.4999999999999999
  2 0.4 0.7777777777777779 0.6185714285714285
  2 0.4 0.7777777777777779 0.3814285714285714
  1 0.5 0.8333333333333334 0.4999999999999999
  2 0.5 0.9444444444444444 0.6185714285714285
  2 0.5 0.9444444444444444 0.3814285714285714
  1 0.6 0.0 0.4999999999999999
  2 0.6 0.1111111111111111 0.6185714285714285
  2 0.6 0.1111111111111111 0.3814285714285714
  1 0.7 0.1666666666666666 0.4999999999999999
  2 0.7 0.2777777777777778 0.6185714285714285
  2 0.7 0.2777777777777778 0.3814285714285714
  1 0.6 0.3333333333333333 0.4999999999999999
  2 0.6 0.4444444444444445 0.6185714285714285
  2 0.6 0.4444444444444445 0.3814285714285714
  1 0.7 0.5 0.4999999999999999
  2 0.7 0.611111111111111 0.6185714285714285
  2 0.7 0.611111111111111 0.3814285714285714
  1 0.6 0.6666666666666666 0.4999999999999999
  2 0.6 0.7777777777777779 0.6185714285714285
  2 0.6 0.7777777777777779 0.3814285714285714
  1 0.7 0.8333333333333334 0.4999999999999999
  2 0.7 0.9444444444444444 0.6185714285714285
  2 0.7 0.9444444444444444 0.3814285714285714
  1 0.7999999999999999 0.0 0.4999999999999999
  2 0.7999999999999999 0.1111111111111111 0.6185714285714285
  2 0.7999999999999999 0.1111111111111111 0.3814285714285714
  1 0.8999999999999999 0.1666666666666666 0.4999999999999999
  2 0.8999999999999999 0.2777777777777778 0.6185714285714285
  2 0.8999999999999999 0.2777777777777778 0.3814285714285714
  1 0.7999999999999999 0.3333333333333333 0.4999999999999999
  2 0.7999999999999999 0.4444444444444445 0.6185714285714285
  2 0.7999999999999999 0.4444444444444445 0.3814285714285714
  1 0.8999999999999999 0.5 0.4999999999999999
  2 0.8999999999999999 0.611111111111111 0.6185714285714285
  2 0.8999999999999999 0.611111111111111 0.3814285714285714
  1 0.7999999999999999 0.6666666666666666 0.4999999999999999
  2 0.7999999999999999 0.7777777777777779 0.6185714285714285
  2 0.7999999999999999 0.7777777777777779 0.3814285714285714
  1 0.8999999999999999 0.8333333333333334 0.4999999999999999
  2 0.8999999999999999 0.9444444444444444 0.6185714285714285
  2 0.8999999999999999 0.9444444444444444 0.3814285714285714
/


EOF

${ALAMODEDIR}/alm/alm ${prefix}_opt.alm.in > ${prefix}_opt.alm.log0 2> ${prefix}_opt.alm.err

cat << EOF > ${prefix}_phband_GM.in
    &general
    PREFIX = ${prefix}_GM
    MODE   = phonons
    FCSXML = ${prefix}.xml
    MASS = 95.94873241 78.9595608
    NKD = 2
    KD = Mo Se 
    NONANALYTIC = 3
    BORNINFO = borninfo
    BORNSYM = 1
    /

    &cell
        1.8897261246257702
        3.27 0.0 0.0
        -1.635 2.8319030703751142 0.0
        0.0 0.0 14.0
    /

    &kpoint
    1
    G 0.0 0.0 0.0 M 0.5 0.0 0.0 100
    /

EOF

${ALAMODEDIR}/anphon/anphon ${prefix}_phband_GM.in > ${prefix}_phband_GM.out

cat << EOF > ${prefix}_phband_GKM.in
    &general
    PREFIX = ${prefix}_GKM
    MODE   = phonons
    FCSXML = ${prefix}.xml
    MASS = 95.94873241 78.9595608
    NKD = 2
    KD = Mo Se 
    NONANALYTIC = 3
    BORNINFO = borninfo
    BORNSYM = 1
    /

    &cell
        1.8897261246257702
        3.27 0.0 0.0
        -1.635 2.8319030703751142 0.0
        0.0 0.0 14.0 
    /

    &kpoint
    1
    G 0.0 0.0 0.0 K 0.3333333 0.3333333 0.0 49 
    K 0.3333333 0.3333333 0.0 M 0.5 0.0 0.0 50
    /


EOF

${ALAMODEDIR}/anphon/anphon ${prefix}_phband_GKM.in > ${prefix}_phband_GKM.out

done

done

done

done

#-----------------Calculation-----------------------


